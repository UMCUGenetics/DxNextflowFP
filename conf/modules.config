/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    withName: BWAMEM2_MEM {
        cpus = 6
        memory = { 30.GB * task.attempt }
        time = { 2.h * task.attempt }
        clusterOptions = "${params.cluster_options} --gres=tmpspace:20G"

        ext.args = { "-R '@RG\\tID:${meta.rg_id}\\tSM:${meta.id}\\tPL:ILLUMINA\\tLB:${meta.id}\\tPU:${meta.flowcell}' -K 100000000 -Y" }
        ext.prefix = { "${meta.rg_id}" }
    }

    withName: CUSTOM_DUMPSOFTWAREVERSIONS {
        cpus = 2
        memory = { 10.GB * task.attempt }
        time = { 10.m * task.attempt }

        publishDir {
            path = "${params.outdir}/log"
            mode = params.publish_dir_mode
            pattern = 'software_versions.yml'
        }

    }

    withName: FASTQC {
        cpus = 2
        memory = { 10.GB * task.attempt }
        time = { 2.h * task.attempt }

        ext.args = '--quiet'

        publishDir {
            path = "${params.outdir}/QC/fastqc"
            mode = params.publish_dir_mode
            pattern = '*_{fastqc.html}'
        }
    }

    withName: GATK4_HAPLOTYPECALLER {
        cpus = 2
        memory = { 10.GB * task.attempt }
        time = { 10.m * task.attempt }

        ext.args = "--emit-ref-confidence BP_RESOLUTION"
        ext.prefix = { "${meta.id}.g" }
    }

    withName: GATK4_GENOTYPEGVCFS{
        cpus = 2
        memory = { 10.GB * task.attempt }
        time = { 10.m * task.attempt }

        ext.args = "--include-non-variant-sites"

        publishDir {
            path = "${params.outdir}/vcf_files"
            mode = params.publish_dir_mode
            saveAs = { filename -> filename.equals('versions.yml') ? null : filename }
        }
    }

    withName: SAMTOOLS_INDEX {
        cpus   = { 2 * task.attempt }
        memory = { 10.GB * task.attempt }
        time   = { 1.h * task.attempt }
    }

    withName: SAMTOOLS_INDEX_UMITOOLS {
        cpus   = { 2 * task.attempt }
        memory = { 10.GB * task.attempt }
        time   = { 1.h * task.attempt }

        publishDir {
            path = "${params.outdir}/bam_files"
            mode = params.publish_dir_mode
            pattern = '*bai'
            saveAs = { filename -> filename.equals('versions.yml') ? null : filename }
        }
    }

    withName: SAMTOOLS_MERGE {
        cpus   = { 2 * task.attempt }
        memory = { 10.GB * task.attempt }
        time   = { 1.h * task.attempt }
        ext.prefix = { "${meta.id}_merge" }
    }

    withName: UMITOOLS_DEDUP {
        cpus   = { 2 * task.attempt }
        memory = { 20.GB * task.attempt }
        time   = { 1.h * task.attempt }
        ext.args = { " --umi-separator=\":\"  " }
        ext.prefix = { "${meta.id}_dedup" }
        publishDir {
            path = "${params.outdir}/bam_files"
            mode = params.publish_dir_mode
            pattern = '*bam'
            saveAs = { filename -> filename.equals('versions.yml') ? null : filename }
        }

    }

    withName: TRIMGALORE {
        cpus   = { 2 * task.attempt }
        memory = { 20.GB * task.attempt }
        time   = { 1.h * task.attempt }
    }

    withName: MULTIQC {
        cpus = 2
        memory = { 10.GB * task.attempt }
        time = { 10.m * task.attempt }

        publishDir {
            path = "${params.outdir}/QC"
            mode = params.publish_dir_mode
            saveAs = { filename -> filename.equals('versions.yml') ? null : filename }
        }
    }
}
